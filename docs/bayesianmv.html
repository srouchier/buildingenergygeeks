<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Bayesian M&amp;V | Building energy statistical modelling</title>
  <meta name="description" content="Handbook of statistical learning for building energy performance." />
  <meta name="generator" content="bookdown 0.26 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Bayesian M&amp;V | Building energy statistical modelling" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Handbook of statistical learning for building energy performance." />
  <meta name="github-repo" content="srouchier/buildingenergygeeks" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Bayesian M&amp;V | Building energy statistical modelling" />
  
  <meta name="twitter:description" content="Handbook of statistical learning for building energy performance." />
  

<meta name="author" content="Simon Rouchier" />


<meta name="date" content="2022-07-06" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="ordinary-linear-regression.html"/>
<link rel="next" href="finite-mixture-models.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./index.html">Building energy statistical modelling</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Home page</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#motivation"><i class="fa fa-check"></i>Motivation</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#content-of-the-book"><i class="fa fa-check"></i>Content of the book</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#programming-languages"><i class="fa fa-check"></i>Programming languages</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about"><i class="fa fa-check"></i>About</a></li>
</ul></li>
<li class="part"><span><b>I Theory and workflow</b></span></li>
<li class="chapter" data-level="1" data-path="scope.html"><a href="scope.html"><i class="fa fa-check"></i><b>1</b> Background on data analysis</a>
<ul>
<li class="chapter" data-level="1.1" data-path="scope.html"><a href="scope.html#the-energy-savings-potential-of-buildings"><i class="fa fa-check"></i><b>1.1</b> The energy savings potential of buildings</a></li>
<li class="chapter" data-level="1.2" data-path="scope.html"><a href="scope.html#from-data-to-energy-savings"><i class="fa fa-check"></i><b>1.2</b> From data to energy savings</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="scope.html"><a href="scope.html#formalisation-of-the-system"><i class="fa fa-check"></i><b>1.2.1</b> Formalisation of the system</a></li>
<li class="chapter" data-level="1.2.2" data-path="scope.html"><a href="scope.html#some-uses-of-data"><i class="fa fa-check"></i><b>1.2.2</b> Some uses of data</a></li>
<li class="chapter" data-level="1.2.3" data-path="scope.html"><a href="scope.html#model-calibration-as-the-key-to-data-analysis"><i class="fa fa-check"></i><b>1.2.3</b> Model calibration as the key to data analysis</a></li>
<li class="chapter" data-level="1.2.4" data-path="scope.html"><a href="scope.html#inverseproblems"><i class="fa fa-check"></i><b>1.2.4</b> The difficulty of inverse problems</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="scope.html"><a href="scope.html#categories"><i class="fa fa-check"></i><b>1.3</b> Categories of data-driven modelling approaches</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="scope.html"><a href="scope.html#either-physical-interpretability-or-prediction-accuracy"><i class="fa fa-check"></i><b>1.3.1</b> Either physical interpretability or prediction accuracy</a></li>
<li class="chapter" data-level="1.3.2" data-path="scope.html"><a href="scope.html#calibrated-simulation-white-box"><i class="fa fa-check"></i><b>1.3.2</b> Calibrated simulation (white-box)</a></li>
<li class="chapter" data-level="1.3.3" data-path="scope.html"><a href="scope.html#machine-learning-black-box"><i class="fa fa-check"></i><b>1.3.3</b> Machine learning (black-box)</a></li>
<li class="chapter" data-level="1.3.4" data-path="scope.html"><a href="scope.html#statistical-modelling-and-inference-grey-box"><i class="fa fa-check"></i><b>1.3.4</b> Statistical modelling and inference (grey-box)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="modelling.html"><a href="modelling.html"><i class="fa fa-check"></i><b>2</b> Building energy statistical modelling</a>
<ul>
<li class="chapter" data-level="2.1" data-path="modelling.html"><a href="modelling.html#modelling1"><i class="fa fa-check"></i><b>2.1</b> Building physics in a nutshell</a></li>
<li class="chapter" data-level="2.2" data-path="modelling.html"><a href="modelling.html#modelling2"><i class="fa fa-check"></i><b>2.2</b> Measurement and modelling boundaries</a></li>
<li class="chapter" data-level="2.3" data-path="modelling.html"><a href="modelling.html#modelling3"><i class="fa fa-check"></i><b>2.3</b> Categories of statistical models</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="workflow.html"><a href="workflow.html"><i class="fa fa-check"></i><b>3</b> A Bayesian data analysis workflow</a>
<ul>
<li class="chapter" data-level="3.1" data-path="workflow.html"><a href="workflow.html#bayesian"><i class="fa fa-check"></i><b>3.1</b> Bayesian inference summarised</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="workflow.html"><a href="workflow.html#motivation-for-a-bayesian-approach"><i class="fa fa-check"></i><b>3.1.1</b> Motivation for a Bayesian approach</a></li>
<li class="chapter" data-level="3.1.2" data-path="workflow.html"><a href="workflow.html#general-bayesian-principles"><i class="fa fa-check"></i><b>3.1.2</b> General Bayesian principles</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="workflow.html"><a href="workflow.html#workflow-for-one-model"><i class="fa fa-check"></i><b>3.2</b> Workflow for one model</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="workflow.html"><a href="workflow.html#overview"><i class="fa fa-check"></i><b>3.2.1</b> Overview</a></li>
<li class="chapter" data-level="3.2.2" data-path="workflow.html"><a href="workflow.html#step-1-model-specification"><i class="fa fa-check"></i><b>3.2.2</b> Step 1: model specification</a></li>
<li class="chapter" data-level="3.2.3" data-path="workflow.html"><a href="workflow.html#priorpredictivechecking"><i class="fa fa-check"></i><b>3.2.3</b> Prior predictive checking</a></li>
<li class="chapter" data-level="3.2.4" data-path="workflow.html"><a href="workflow.html#computation"><i class="fa fa-check"></i><b>3.2.4</b> Step 2: computation with Markov Chain Monte Carlo</a></li>
<li class="chapter" data-level="3.2.5" data-path="workflow.html"><a href="workflow.html#modelvalidation"><i class="fa fa-check"></i><b>3.2.5</b> Step 3: model checking and validation</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="workflow.html"><a href="workflow.html#modelselection"><i class="fa fa-check"></i><b>3.3</b> Model assessment and selection</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="workflow.html"><a href="workflow.html#model-selection-workflows"><i class="fa fa-check"></i><b>3.3.1</b> Model selection workflows</a></li>
<li class="chapter" data-level="3.3.2" data-path="workflow.html"><a href="workflow.html#sensitivity-analysis"><i class="fa fa-check"></i><b>3.3.2</b> Sensitivity analysis</a></li>
<li class="chapter" data-level="3.3.3" data-path="workflow.html"><a href="workflow.html#structural-identifiability"><i class="fa fa-check"></i><b>3.3.3</b> Structural identifiability</a></li>
<li class="chapter" data-level="3.3.4" data-path="workflow.html"><a href="workflow.html#inferencediagnostics"><i class="fa fa-check"></i><b>3.3.4</b> Practical identifiability</a></li>
<li class="chapter" data-level="3.3.5" data-path="workflow.html"><a href="workflow.html#modelcomparison"><i class="fa fa-check"></i><b>3.3.5</b> Model comparison criteria</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>II Temporally independent data</b></span></li>
<li class="chapter" data-level="4" data-path="ordinary-linear-regression.html"><a href="ordinary-linear-regression.html"><i class="fa fa-check"></i><b>4</b> Ordinary linear regression</a>
<ul>
<li class="chapter" data-level="4.1" data-path="ordinary-linear-regression.html"><a href="ordinary-linear-regression.html#introduction-to-olr"><i class="fa fa-check"></i><b>4.1</b> Introduction to OLR</a></li>
<li class="chapter" data-level="4.2" data-path="ordinary-linear-regression.html"><a href="ordinary-linear-regression.html#tutorial-olr-with-r"><i class="fa fa-check"></i><b>4.2</b> Tutorial: OLR with R</a></li>
<li class="chapter" data-level="4.3" data-path="ordinary-linear-regression.html"><a href="ordinary-linear-regression.html#simple-linear-regression-with-r"><i class="fa fa-check"></i><b>4.3</b> Simple linear regression with R</a></li>
<li class="chapter" data-level="4.4" data-path="ordinary-linear-regression.html"><a href="ordinary-linear-regression.html#bayesian-regression-with-stan"><i class="fa fa-check"></i><b>4.4</b> Bayesian regression with Stan</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="bayesianmv.html"><a href="bayesianmv.html"><i class="fa fa-check"></i><b>5</b> Bayesian M&amp;V</a>
<ul>
<li class="chapter" data-level="5.1" data-path="bayesianmv.html"><a href="bayesianmv.html#a-bayesian-workflow-for-mv"><i class="fa fa-check"></i><b>5.1</b> A Bayesian workflow for M&amp;V</a></li>
<li class="chapter" data-level="5.2" data-path="bayesianmv.html"><a href="bayesianmv.html#change-point-models"><i class="fa fa-check"></i><b>5.2</b> Change-point models</a></li>
<li class="chapter" data-level="5.3" data-path="bayesianmv.html"><a href="bayesianmv.html#ipmvp-option-c-example-rstan"><i class="fa fa-check"></i><b>5.3</b> IPMVP option C example (Rstan)</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="bayesianmv.html"><a href="bayesianmv.html#loading-and-displaying-the-data"><i class="fa fa-check"></i><b>5.3.1</b> Loading and displaying the data</a></li>
<li class="chapter" data-level="5.3.2" data-path="bayesianmv.html"><a href="bayesianmv.html#daily-averaged-data"><i class="fa fa-check"></i><b>5.3.2</b> Daily averaged data</a></li>
<li class="chapter" data-level="5.3.3" data-path="bayesianmv.html"><a href="bayesianmv.html#model-definition"><i class="fa fa-check"></i><b>5.3.3</b> Model definition</a></li>
<li class="chapter" data-level="5.3.4" data-path="bayesianmv.html"><a href="bayesianmv.html#model-specification-with-stan"><i class="fa fa-check"></i><b>5.3.4</b> Model specification with Stan</a></li>
<li class="chapter" data-level="5.3.5" data-path="bayesianmv.html"><a href="bayesianmv.html#model-fitting"><i class="fa fa-check"></i><b>5.3.5</b> Model fitting</a></li>
<li class="chapter" data-level="5.3.6" data-path="bayesianmv.html"><a href="bayesianmv.html#validation-and-results"><i class="fa fa-check"></i><b>5.3.6</b> Validation and results</a></li>
<li class="chapter" data-level="5.3.7" data-path="bayesianmv.html"><a href="bayesianmv.html#residuals"><i class="fa fa-check"></i><b>5.3.7</b> Residuals</a></li>
<li class="chapter" data-level="5.3.8" data-path="bayesianmv.html"><a href="bayesianmv.html#savings"><i class="fa fa-check"></i><b>5.3.8</b> Savings</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="finite-mixture-models.html"><a href="finite-mixture-models.html"><i class="fa fa-check"></i><b>6</b> Finite mixture models</a>
<ul>
<li class="chapter" data-level="6.1" data-path="finite-mixture-models.html"><a href="finite-mixture-models.html#principle"><i class="fa fa-check"></i><b>6.1</b> Principle</a></li>
<li class="chapter" data-level="6.2" data-path="finite-mixture-models.html"><a href="finite-mixture-models.html#tutorial-rstan"><i class="fa fa-check"></i><b>6.2</b> Tutorial (Rstan)</a></li>
</ul></li>
<li class="part"><span><b>III Time-series modelling</b></span></li>
<li class="chapter" data-level="7" data-path="armax.html"><a href="armax.html"><i class="fa fa-check"></i><b>7</b> Autoregressive models</a>
<ul>
<li class="chapter" data-level="7.1" data-path="armax.html"><a href="armax.html#principle-of-armax-models"><i class="fa fa-check"></i><b>7.1</b> Principle of ARMAX models</a></li>
<li class="chapter" data-level="7.2" data-path="armax.html"><a href="armax.html#tutorial-rstan-1"><i class="fa fa-check"></i><b>7.2</b> Tutorial (Rstan)</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="armax.html"><a href="armax.html#data-the-ashrae-machine-learning-competition"><i class="fa fa-check"></i><b>7.2.1</b> Data: the ASHRAE machine learning competition</a></li>
<li class="chapter" data-level="7.2.2" data-path="armax.html"><a href="armax.html#a-simple-arx-model"><i class="fa fa-check"></i><b>7.2.2</b> A simple ARX model</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="hmm.html"><a href="hmm.html"><i class="fa fa-check"></i><b>8</b> Hidden Markov models</a>
<ul>
<li class="chapter" data-level="8.1" data-path="hmm.html"><a href="hmm.html#principles"><i class="fa fa-check"></i><b>8.1</b> Principles</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="hmm.html"><a href="hmm.html#the-forward-algorithm"><i class="fa fa-check"></i><b>8.1.1</b> The forward algorithm</a></li>
<li class="chapter" data-level="8.1.2" data-path="hmm.html"><a href="hmm.html#the-viterbi-algorithm"><i class="fa fa-check"></i><b>8.1.2</b> The Viterbi algorithm</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="hmm.html"><a href="hmm.html#tutorial-python"><i class="fa fa-check"></i><b>8.2</b> Tutorial (Python)</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="composite-time-series-models.html"><a href="composite-time-series-models.html"><i class="fa fa-check"></i><b>9</b> Composite time series models</a>
<ul>
<li class="chapter" data-level="9.1" data-path="composite-time-series-models.html"><a href="composite-time-series-models.html#markov-switching-models"><i class="fa fa-check"></i><b>9.1</b> Markov switching models</a></li>
<li class="chapter" data-level="9.2" data-path="composite-time-series-models.html"><a href="composite-time-series-models.html#hidden-markov-energy-signature"><i class="fa fa-check"></i><b>9.2</b> Hidden Markov energy signature</a></li>
</ul></li>
<li class="part"><span><b>IV State-space models</b></span></li>
<li class="chapter" data-level="10" data-path="ssmprinciple.html"><a href="ssmprinciple.html"><i class="fa fa-check"></i><b>10</b> Principle of SSMs</a>
<ul>
<li class="chapter" data-level="10.1" data-path="ssmprinciple.html"><a href="ssmprinciple.html#description"><i class="fa fa-check"></i><b>10.1</b> Description</a></li>
<li class="chapter" data-level="10.2" data-path="ssmprinciple.html"><a href="ssmprinciple.html#linearssm"><i class="fa fa-check"></i><b>10.2</b> Linear state-space models</a></li>
<li class="chapter" data-level="10.3" data-path="ssmprinciple.html"><a href="ssmprinciple.html#kalmanfilter"><i class="fa fa-check"></i><b>10.3</b> The Kalman filter</a></li>
<li class="chapter" data-level="10.4" data-path="ssmprinciple.html"><a href="ssmprinciple.html#non-linear-state-space-models"><i class="fa fa-check"></i><b>10.4</b> Non-linear state-space models</a></li>
<li class="chapter" data-level="10.5" data-path="ssmprinciple.html"><a href="ssmprinciple.html#switching-state-space-models"><i class="fa fa-check"></i><b>10.5</b> Switching state-space models</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="a-simple-rc-model-python.html"><a href="a-simple-rc-model-python.html"><i class="fa fa-check"></i><b>11</b> A simple RC model (Python)</a>
<ul>
<li class="chapter" data-level="11.1" data-path="a-simple-rc-model-python.html"><a href="a-simple-rc-model-python.html#case-study"><i class="fa fa-check"></i><b>11.1</b> Case study</a></li>
<li class="chapter" data-level="11.2" data-path="a-simple-rc-model-python.html"><a href="a-simple-rc-model-python.html#modelling-1"><i class="fa fa-check"></i><b>11.2</b> Modelling</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="a-simple-rc-model-python.html"><a href="a-simple-rc-model-python.html#rc-model"><i class="fa fa-check"></i><b>11.2.1</b> RC model</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="a-simple-rc-model-python.html"><a href="a-simple-rc-model-python.html#deterministic-formulation"><i class="fa fa-check"></i><b>11.3</b> Deterministic formulation</a></li>
<li class="chapter" data-level="11.4" data-path="a-simple-rc-model-python.html"><a href="a-simple-rc-model-python.html#stochastic-formulation"><i class="fa fa-check"></i><b>11.4</b> Stochastic formulation</a>
<ul>
<li class="chapter" data-level="11.4.1" data-path="a-simple-rc-model-python.html"><a href="a-simple-rc-model-python.html#specification"><i class="fa fa-check"></i><b>11.4.1</b> Specification</a></li>
<li class="chapter" data-level="11.4.2" data-path="a-simple-rc-model-python.html"><a href="a-simple-rc-model-python.html#training"><i class="fa fa-check"></i><b>11.4.2</b> Training</a></li>
<li class="chapter" data-level="11.4.3" data-path="a-simple-rc-model-python.html"><a href="a-simple-rc-model-python.html#diagnostics-and-residuals-analysis"><i class="fa fa-check"></i><b>11.4.3</b> Diagnostics and residuals analysis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="the-pysip-library-python.html"><a href="the-pysip-library-python.html"><i class="fa fa-check"></i><b>12</b> The pySIP library (Python)</a></li>
<li class="part"><span><b>V Gaussian Process models</b></span></li>
<li class="chapter" data-level="13" data-path="gaussian-process-models.html"><a href="gaussian-process-models.html"><i class="fa fa-check"></i><b>13</b> Gaussian Process models</a>
<ul>
<li class="chapter" data-level="13.1" data-path="gaussian-process-models.html"><a href="gaussian-process-models.html#principle-1"><i class="fa fa-check"></i><b>13.1</b> Principle</a></li>
<li class="chapter" data-level="13.2" data-path="gaussian-process-models.html"><a href="gaussian-process-models.html#gaussian-processes-for-prediction-of-energy-use"><i class="fa fa-check"></i><b>13.2</b> Gaussian Processes for prediction of energy use</a></li>
<li class="chapter" data-level="13.3" data-path="gaussian-process-models.html"><a href="gaussian-process-models.html#gaussian-processes-for-time-series-data"><i class="fa fa-check"></i><b>13.3</b> Gaussian Processes for time series data</a></li>
<li class="chapter" data-level="13.4" data-path="gaussian-process-models.html"><a href="gaussian-process-models.html#latent-force-models"><i class="fa fa-check"></i><b>13.4</b> Latent Force Models</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Building energy statistical modelling</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="bayesianmv" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Chapter 5</span> Bayesian M&amp;V<a href="bayesianmv.html#bayesianmv" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="a-bayesian-workflow-for-mv" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> A Bayesian workflow for M&amp;V<a href="bayesianmv.html#a-bayesian-workflow-for-mv" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This tutorial applies the principles of Bayesian data analysis described in Sec. <a href="workflow.html#bayesian">3.1</a> to a Measurement and Verification (M&amp;V) problem. In a nutshell, M&amp;V aims at reliably assessing the energy savings that were actually gained from energy conservation measures (ECM). One of the main M&amp;V workflows, formalised by the IPMVP, is the “reporting period basis”, or “avoided consumption” method:</p>
<ul>
<li>a numerical model is trained during a baseline observation period (before ECMs are applied);</li>
<li>the trained model is used to predict energy consumption during the reporting period (after energy conservation measures);</li>
<li>predictions are compared with the measured consumption of the reporting period, in order to estimate adjusted energy savings</li>
</ul>
<p>This method therefore requires data to be recorded before and after implementation of the ECM, for a sufficiently long time. Fig. <a href="bayesianmv.html#fig:mvworkflow">5.1</a> shows the main steps of this method, when following a Bayesian approach. We assume that the measurement boundaries have been defined and that data have been recorded during the baseline and reporting period respectively.</p>
<div class="figure"><span style="display:block;" id="fig:mvworkflow"></span>
<img src="figures/501_workflow.png" alt="Estimation of savings with uncertainty in an avoided consumption workflow. The step of model validation is not displayed" width="100%" />
<p class="caption">
Figure 5.1: Estimation of savings with uncertainty in an avoided consumption workflow. The step of model validation is not displayed
</p>
</div>
<ul>
<li>As with standard approaches, choose a model structure to describe the data with, and formulate it as a likelihood function. Formulate eventual “expert knowledge” assumptions in the form of prior probability distributions.</li>
<li>Run a MCMC (or other) algorithm to obtain a set of samples <span class="math inline">\(\left(\theta^{(1)},...,\theta^{(S)}\right)\)</span> which approximates the posterior distribution of parameters conditioned on the baseline data <span class="math inline">\(p(\theta|y_\mathit{base})\)</span>. Validate the inference by checking convergence diagnostics: <span class="math inline">\(\hat{R}\)</span>, ESS, etc.</li>
<li>Validate the model by computing its predictions during the baseline period <span class="math inline">\(p(\tilde{y}_\mathit{base}|y_\mathit{base})\)</span>. This can be done by taking all (or a representative set of) samples individually, and running a model simulation <span class="math inline">\(\tilde{y}_\mathit{base}^{(s)} \sim p(y_\mathit{base}|\theta=\theta^{(s)})\)</span> for each. This set of simulations generates the posterior predictive distribution of the baseline period, from which any statistic can be derived (mean, median, prediction intervals for any quantile, etc.). The measures of model validation (<span class="math inline">\(R^2\)</span>, net determination bias, t-statistic…) can then be computed either from the mean, or from all samples in order to obtain their own probability densities.</li>
<li>Compute the reporting period predictions in the same discrete way: each sample <span class="math inline">\(\theta^{(s)}\)</span> generates a profile <span class="math inline">\(\tilde{y}_\mathit{repo}^{(s)} \sim p(y_\mathit{repo}|\theta=\theta^{(s)})\)</span>, and this set of simulations generates the posterior predictive distribution of the reporting period.</li>
<li>Since each reporting period prediction <span class="math inline">\(\tilde{y}_\mathit{repo}^{(s)}\)</span> can be compared with the measured reporting period consumption <span class="math inline">\(y_\mathit{repo}\)</span>, we can obtain <span class="math inline">\(S\)</span> values for the energy savings, which distribution approximate the posterior probability of savings.</li>
</ul>
</div>
<div id="change-point-models" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Change-point models<a href="bayesianmv.html#change-point-models" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Some systems are dependent on a variable, but only above or below a certain value. For example, cooling energy use may be proportional to ambient temperature, yet only above a certain threshold. When ambient temperature decreases to below the threshold, the cooling energy use does not continue to decrease, because the fan energy remains constant. In cases like these, simple regression can be improved by using a change-point linear regression. Change point models often have a better fit than a simple regression, especially when modeling energy usage for a facility.</p>
<p>The energy signature of a building decomposes the total energy consumption (or power <span class="math inline">\(\Phi\)</span>) into three terms: heating, cooling, and other uses. Heating and cooling are then assumed to be linearly dependent on the outdoor air temperature <span class="math inline">\(T_e\)</span>, and only turned on conditionally on two threshold temperatures <span class="math inline">\(T_{b1}\)</span> and <span class="math inline">\(T_{b2}\)</span>, respectively.
<span class="math display" id="eq:mv3" id="eq:mv2" id="eq:mv1">\[\begin{align}
  E(\Phi|\theta, X) &amp; = \Phi_0 + \mathrm{HTC}_1 \, \left(T_{b1} - T_e\right) &amp; \mathrm{if} \quad T_e \leq T_{b1} \tag{5.1} \\
  E(\Phi|\theta, X) &amp; = \Phi_0 &amp; \mathrm{if} \quad T_{b1} \leq T_e \leq T_{b2} \tag{5.2} \\
    E(\Phi|\theta, X) &amp; = \Phi_0 + \mathrm{HTC}_2 \, \left(T_e - T_{b2}\right) &amp; \mathrm{if} \quad T_{b2} \leq T_e \tag{5.3}
\end{align}\]</span>
Data points should be averaged over long enough (at least daily) sampling times, so that the steady-state assumption formulated above can hold. <span class="math inline">\(\Phi_0\)</span> is the average baseline consumption during each sampling period, of all energy uses besides heating and cooling. Heating is turned on if the outdoor air temperature drops below a basis temperature <span class="math inline">\(T_{b1}\)</span>, and the heating power <span class="math inline">\(\Phi_h = \mathrm{HTC}_1 \, \left(T_{b1} - T_e\right)\)</span> is assumed proportional to a heat transfer coefficeint (HTC) value. The same reasoning is used to formulate cooling, with a “summer HTC” value that may be different from the first one. This model is therefore a piecewise linear regression model, where the switching points <span class="math inline">\(T_{b1}\)</span> and <span class="math inline">\(T_{b2}\)</span> are usually to be identified along with the other parameters.</p>
<p>The appeal of the energy signature model is that the only data it requires are energy meter readings and outdoor air temperature, with a large sampling time.</p>
</div>
<div id="ipmvp-option-c-example-rstan" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> IPMVP option C example (Rstan)<a href="bayesianmv.html#ipmvp-option-c-example-rstan" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="bayesianmv.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb19-2"><a href="bayesianmv.html#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb19-3"><a href="bayesianmv.html#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span></code></pre></div>
<p>The data used in this example is the hourly energy consumption and outdoor air temperature data for 11 commercial buildings (office/retail), publicly available here:</p>
<p><a href="https://openei.org/datasets/dataset/consumption-outdoor-air-temperature-11-commercial-buildings" class="uri">https://openei.org/datasets/dataset/consumption-outdoor-air-temperature-11-commercial-buildings</a></p>
<p>We will be using two data files, respectively labeled <em>Building 6 (Office “Pre”)</em>, and <em>Building 6 (Office “Post”)</em>.</p>
<div id="loading-and-displaying-the-data" class="section level3 hasAnchor" number="5.3.1">
<h3><span class="header-section-number">5.3.1</span> Loading and displaying the data<a href="bayesianmv.html#loading-and-displaying-the-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The following block loads two separate data files:</p>
<ul>
<li><code>building60preoffice.csv</code> is the baseline period file, saved into the df.base variable</li>
<li><code>building60postoffice.csv</code> is the reporting period file, saved into the df.repo variable</li>
</ul>
<p>The <code>Date</code> column of both files is converted into a DateTime type into a new column. Then, the baseline dataset is displayed for a first exploratory look at the data.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="bayesianmv.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Baseline data: one year</span></span>
<span id="cb20-2"><a href="bayesianmv.html#cb20-2" aria-hidden="true" tabindex="-1"></a>df.base <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;data/building60preoffice.csv&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb20-3"><a href="bayesianmv.html#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DateTime =</span> <span class="fu">mdy_hm</span>(Date),</span>
<span id="cb20-4"><a href="bayesianmv.html#cb20-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">Date =</span> <span class="fu">as_date</span>(DateTime))</span>
<span id="cb20-5"><a href="bayesianmv.html#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="bayesianmv.html#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Post-retrofit data: one year</span></span>
<span id="cb20-7"><a href="bayesianmv.html#cb20-7" aria-hidden="true" tabindex="-1"></a>df.repo <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;data/building62postoffice.csv&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb20-8"><a href="bayesianmv.html#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DateTime =</span> <span class="fu">mdy_hm</span>(Date),</span>
<span id="cb20-9"><a href="bayesianmv.html#cb20-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">Date =</span> <span class="fu">as_date</span>(DateTime))</span>
<span id="cb20-10"><a href="bayesianmv.html#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="bayesianmv.html#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the original data</span></span>
<span id="cb20-12"><a href="bayesianmv.html#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df.base)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 4
##   Date         OAT `Building 6 kW` DateTime           
##   &lt;date&gt;     &lt;dbl&gt;           &lt;dbl&gt; &lt;dttm&gt;             
## 1 2009-01-02  41.6            23.3 2009-01-02 00:00:00
## 2 2009-01-02  40.9            23.1 2009-01-02 01:00:00
## 3 2009-01-02  39.5            23.7 2009-01-02 02:00:00
## 4 2009-01-02  36.3            29.1 2009-01-02 03:00:00
## 5 2009-01-02  32.8            35.6 2009-01-02 04:00:00
## 6 2009-01-02  32.5            45.5 2009-01-02 05:00:00</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="bayesianmv.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> df.base) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>DateTime, <span class="at">y=</span><span class="st">`</span><span class="at">Building 6 kW</span><span class="st">`</span>))</span></code></pre></div>
<p><img src="buildingenergygeeks_files/figure-html/mv02-1.png" width="672" /></p>
<p>A few interesting observations:</p>
<ul>
<li>The data has a hourly time step size. Every hour, the outdoor air temperature (OAT in °F) and energy use (kW) are available.</li>
<li>The energy use is higher in summer and in winter than in-between. This suggests that this consumption data includes both heating and cooling appliances.</li>
<li>Week-ends are clearly visible with a lower consumption than in the working days of the week.</li>
</ul>
</div>
<div id="daily-averaged-data" class="section level3 hasAnchor" number="5.3.2">
<h3><span class="header-section-number">5.3.2</span> Daily averaged data<a href="bayesianmv.html#daily-averaged-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Averaging the data over daily time steps should allow to overlook the dependence between consecutive measurements. In turn, this allows using a model which will be much simpler than time series models, but will only be capable of low frequency predictions.</p>
<p>The following block creates new datasets from the original ones:</p>
<ul>
<li>Measurements are daily averaged</li>
<li>Temperatures are switched to °C for international suitability.</li>
<li>A categorical variable is added to indicate week ends.</li>
</ul>
<p>Then, we plot the daily energy use <span class="math inline">\(E\)</span> (kWh) versus the outdoor temperature <span class="math inline">\(T\)</span> (°C) for both values of the <code>week.end</code> categorical variable.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="bayesianmv.html#cb23-1" aria-hidden="true" tabindex="-1"></a>daily.average <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb23-2"><a href="bayesianmv.html#cb23-2" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span> </span>
<span id="cb23-3"><a href="bayesianmv.html#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span> </span>
<span id="cb23-4"><a href="bayesianmv.html#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">OAT =</span> <span class="fu">mean</span>(OAT),</span>
<span id="cb23-5"><a href="bayesianmv.html#cb23-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">E =</span> <span class="fu">sum</span>(<span class="st">`</span><span class="at">Building 6 kW</span><span class="st">`</span>),</span>
<span id="cb23-6"><a href="bayesianmv.html#cb23-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">.groups =</span> <span class="st">&#39;drop&#39;</span></span>
<span id="cb23-7"><a href="bayesianmv.html#cb23-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb23-8"><a href="bayesianmv.html#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">wday =</span> <span class="fu">wday</span>(Date),</span>
<span id="cb23-9"><a href="bayesianmv.html#cb23-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">week.end =</span> wday<span class="sc">==</span><span class="dv">1</span> <span class="sc">|</span> wday<span class="sc">==</span><span class="dv">7</span>,</span>
<span id="cb23-10"><a href="bayesianmv.html#cb23-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">T =</span> (OAT<span class="dv">-32</span>) <span class="sc">*</span> <span class="dv">5</span><span class="sc">/</span><span class="dv">9</span>)</span>
<span id="cb23-11"><a href="bayesianmv.html#cb23-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-12"><a href="bayesianmv.html#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="bayesianmv.html#cb23-13" aria-hidden="true" tabindex="-1"></a>df.base.daily <span class="ot">&lt;-</span> <span class="fu">daily.average</span>(df.base)</span>
<span id="cb23-14"><a href="bayesianmv.html#cb23-14" aria-hidden="true" tabindex="-1"></a>df.repo.daily <span class="ot">&lt;-</span> <span class="fu">daily.average</span>(df.repo)</span>
<span id="cb23-15"><a href="bayesianmv.html#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="bayesianmv.html#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> df.base.daily) <span class="sc">+</span></span>
<span id="cb23-17"><a href="bayesianmv.html#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>T, <span class="at">y=</span>E, <span class="at">color=</span>week.end))</span></code></pre></div>
<p><img src="buildingenergygeeks_files/figure-html/mv03-1.png" width="672" /></p>
</div>
<div id="model-definition" class="section level3 hasAnchor" number="5.3.3">
<h3><span class="header-section-number">5.3.3</span> Model definition<a href="bayesianmv.html#model-definition" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>After looking at the data, we can suggest using a change-point model which will include the effects of heating and cooling, and separate week ends from working days. The expected daily energy use <span class="math inline">\(E\)</span> (in kWh per day) is a function of the outdoor temperature <span class="math inline">\(T\)</span> and of a number of parameters:</p>
<ul>
<li>For the week-ends: <span class="math inline">\(p(E|T) \sim \mathcal{N}\left[\alpha_1 + \beta_{1,h}(\tau_{1,h}-T)^+ + \beta_{1,c}(T-\tau_{1,c})^+, \sigma\right]\)</span></li>
<li>For the working days: <span class="math inline">\(p(E|T) \sim \mathcal{N}\left[\alpha_2 + \beta_{2,h}(\tau_{2,h}-T)^+ + \beta_{2,c}(T-\tau_{2,c})^+,\sigma\right]\)</span></li>
</ul>
<p>Where the 1 and 2 subscripts indicate week-ends and working day, respectively, and the <span class="math inline">\(h\)</span> and <span class="math inline">\(c\)</span> subscripts indicate heating and cooling modes. The <span class="math inline">\(+\)</span> superscript indicates that a term is only applied if above zero.</p>
<p>The two equations above mean that we expect the energy use <span class="math inline">\(E\)</span> to be a normal distribution centered around a change-point model, with a constant standard deviation <span class="math inline">\(\sigma\)</span>. Some particularities of Bayesian statistics are: this normal distribution can be replaced by any other probability distribution; the error term <span class="math inline">\(\sigma\)</span> can be formulated as a function of some inputs; etc.</p>
<p><strong>This model has 11 possible parameters</strong>, which makes it significantly more complex than an ordinary linear regression. We could simplify it by assuming that the “working days” and “week ends” mode share the same temperature thresholds for heating (<span class="math inline">\(\tau_{1,h}=\tau_{2,h}\)</span>) or for cooling (<span class="math inline">\(\tau_{1,c}=\tau_{2,c}\)</span>). The following method would also be exactly the same if we decided to complexify the model, for instance by assuming non-linear profiles on each side of the change points, or if we had more categorical variables.</p>
</div>
<div id="model-specification-with-stan" class="section level3 hasAnchor" number="5.3.4">
<h3><span class="header-section-number">5.3.4</span> Model specification with Stan<a href="bayesianmv.html#model-specification-with-stan" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In this example, we use the <a href="https://mc-stan.org/">Stan probabilistic programming language</a>, which allows full Bayesian statistical inference.</p>
<p>A Stan model is a block of text which can either be written in a separate file, or in the same script as the current code. Specifying a model in Stan takes a certain learning curve, but it unlocks the full flexibility of Bayesian analysis.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="bayesianmv.html#cb24-1" aria-hidden="true" tabindex="-1"></a>changepoint <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb24-2"><a href="bayesianmv.html#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="st">functions {</span></span>
<span id="cb24-3"><a href="bayesianmv.html#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="st">  // This chunk is the formula for the changepoint model which will be used several times in this program</span></span>
<span id="cb24-4"><a href="bayesianmv.html#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="st">  real power_mean(int w, real t, vector alpha, vector beta_h, vector tau_h, vector beta_c, vector tau_c) {</span></span>
<span id="cb24-5"><a href="bayesianmv.html#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="st">    real a = w ? alpha[1] : alpha[2];    // condition on the type of day</span></span>
<span id="cb24-6"><a href="bayesianmv.html#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="st">    real heat = w ? beta_h[1] * fmax(tau_h[1]-t, 0) : beta_h[2] * fmax(tau_h[2]-t, 0) ;</span></span>
<span id="cb24-7"><a href="bayesianmv.html#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="st">    real cool = w ? beta_c[1] * fmax(t-tau_c[1], 0) : beta_c[2] * fmax(t-tau_c[2], 0) ;</span></span>
<span id="cb24-8"><a href="bayesianmv.html#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="st">    return (a + heat + cool);</span></span>
<span id="cb24-9"><a href="bayesianmv.html#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb24-10"><a href="bayesianmv.html#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb24-11"><a href="bayesianmv.html#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb24-12"><a href="bayesianmv.html#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="st">  // This block declares all data which will be passed to the Stan model.</span></span>
<span id="cb24-13"><a href="bayesianmv.html#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; N_base;        // number of data items in the baseline period</span></span>
<span id="cb24-14"><a href="bayesianmv.html#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_base] t_base;      // temperature (baseline)</span></span>
<span id="cb24-15"><a href="bayesianmv.html#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="st">  int w_base[N_base];      // categorical variable for the week ends (baseline)</span></span>
<span id="cb24-16"><a href="bayesianmv.html#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_base] y_base;      // outcome energy vector (baseline)</span></span>
<span id="cb24-17"><a href="bayesianmv.html#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb24-18"><a href="bayesianmv.html#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; N_repo;        // number of data items in the reporting period</span></span>
<span id="cb24-19"><a href="bayesianmv.html#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_repo] t_repo;      // temperature (reporting)</span></span>
<span id="cb24-20"><a href="bayesianmv.html#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="st">  int w_repo[N_repo];      // categorical variable for the week ends (reporting)</span></span>
<span id="cb24-21"><a href="bayesianmv.html#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_repo] y_repo;      // outcome energy vector (reporting)</span></span>
<span id="cb24-22"><a href="bayesianmv.html#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb24-23"><a href="bayesianmv.html#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb24-24"><a href="bayesianmv.html#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="st">  // This block declares the parameters of the model. There are 10 parameters plus the error scale sigma</span></span>
<span id="cb24-25"><a href="bayesianmv.html#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[2] alpha;      // baseline consumption (work days and week ends)</span></span>
<span id="cb24-26"><a href="bayesianmv.html#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[2] beta_h;     // slopes for heating</span></span>
<span id="cb24-27"><a href="bayesianmv.html#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[2] tau_h;      // threshold temperatures for heating</span></span>
<span id="cb24-28"><a href="bayesianmv.html#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[2] beta_c;     // slopes for cooling</span></span>
<span id="cb24-29"><a href="bayesianmv.html#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[2] tau_c;      // threshold temperatures for cooling</span></span>
<span id="cb24-30"><a href="bayesianmv.html#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma;  // error scale</span></span>
<span id="cb24-31"><a href="bayesianmv.html#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb24-32"><a href="bayesianmv.html#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb24-33"><a href="bayesianmv.html#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="st">  // Assigning prior distributions on some parameters</span></span>
<span id="cb24-34"><a href="bayesianmv.html#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha ~ normal([400, 800], [150, 150]);</span></span>
<span id="cb24-35"><a href="bayesianmv.html#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="st">  tau_h ~ normal(8, 5);</span></span>
<span id="cb24-36"><a href="bayesianmv.html#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="st">  tau_c ~ normal(18, 5);</span></span>
<span id="cb24-37"><a href="bayesianmv.html#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="st">  beta_h ~ normal(40, 15);</span></span>
<span id="cb24-38"><a href="bayesianmv.html#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="st">  beta_c ~ normal(40, 15);</span></span>
<span id="cb24-39"><a href="bayesianmv.html#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="st">  // Observational model</span></span>
<span id="cb24-40"><a href="bayesianmv.html#cb24-40" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:N_base) {</span></span>
<span id="cb24-41"><a href="bayesianmv.html#cb24-41" aria-hidden="true" tabindex="-1"></a><span class="st">    y_base[n] ~ normal(power_mean(w_base[n], t_base[n], alpha, beta_h, tau_h, beta_c, tau_c), sigma);</span></span>
<span id="cb24-42"><a href="bayesianmv.html#cb24-42" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb24-43"><a href="bayesianmv.html#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb24-44"><a href="bayesianmv.html#cb24-44" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb24-45"><a href="bayesianmv.html#cb24-45" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_base] y_base_pred;</span></span>
<span id="cb24-46"><a href="bayesianmv.html#cb24-46" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_repo] y_repo_pred;</span></span>
<span id="cb24-47"><a href="bayesianmv.html#cb24-47" aria-hidden="true" tabindex="-1"></a><span class="st">  real savings = 0;</span></span>
<span id="cb24-48"><a href="bayesianmv.html#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb24-49"><a href="bayesianmv.html#cb24-49" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:N_base) {</span></span>
<span id="cb24-50"><a href="bayesianmv.html#cb24-50" aria-hidden="true" tabindex="-1"></a><span class="st">    y_base_pred[n] = normal_rng(power_mean(w_base[n], t_base[n], alpha, beta_h, tau_h, beta_c, tau_c), sigma);</span></span>
<span id="cb24-51"><a href="bayesianmv.html#cb24-51" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb24-52"><a href="bayesianmv.html#cb24-52" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb24-53"><a href="bayesianmv.html#cb24-53" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:N_repo) {</span></span>
<span id="cb24-54"><a href="bayesianmv.html#cb24-54" aria-hidden="true" tabindex="-1"></a><span class="st">    y_repo_pred[n] = normal_rng(power_mean(w_repo[n], t_repo[n], alpha, beta_h, tau_h, beta_c, tau_c), sigma);</span></span>
<span id="cb24-55"><a href="bayesianmv.html#cb24-55" aria-hidden="true" tabindex="-1"></a><span class="st">    savings += y_repo_pred[n] - y_repo[n];</span></span>
<span id="cb24-56"><a href="bayesianmv.html#cb24-56" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb24-57"><a href="bayesianmv.html#cb24-57" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb24-58"><a href="bayesianmv.html#cb24-58" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;</span></span></code></pre></div>
<p>Then, a list called <code>model_data</code> is created, which maps each part of the data to its appropriate variable into the Stan model.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="bayesianmv.html#cb25-1" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb25-2"><a href="bayesianmv.html#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_base =</span> <span class="fu">nrow</span>(df.base.daily),</span>
<span id="cb25-3"><a href="bayesianmv.html#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">t_base =</span> df.base.daily<span class="sc">$</span>T,</span>
<span id="cb25-4"><a href="bayesianmv.html#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">w_base =</span> <span class="fu">as.numeric</span>(df.base.daily<span class="sc">$</span>week.end),</span>
<span id="cb25-5"><a href="bayesianmv.html#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_base =</span> df.base.daily<span class="sc">$</span>E,</span>
<span id="cb25-6"><a href="bayesianmv.html#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_repo =</span> <span class="fu">nrow</span>(df.repo.daily),</span>
<span id="cb25-7"><a href="bayesianmv.html#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">t_repo =</span> df.repo.daily<span class="sc">$</span>T,</span>
<span id="cb25-8"><a href="bayesianmv.html#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">w_repo =</span> <span class="fu">as.numeric</span>(df.repo.daily<span class="sc">$</span>week.end),</span>
<span id="cb25-9"><a href="bayesianmv.html#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_repo =</span> df.repo.daily<span class="sc">$</span>E</span>
<span id="cb25-10"><a href="bayesianmv.html#cb25-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="model-fitting" class="section level3 hasAnchor" number="5.3.5">
<h3><span class="header-section-number">5.3.5</span> Model fitting<a href="bayesianmv.html#model-fitting" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now that the model has been specified and the data has been mapped to its variables, the syntax for model fitting is below.</p>
<p>One disadvantage of Bayesian inference is that the MCMC algorithm takes much longer to converge than a typical least-squares model fitting method. Running the code below might take a minute because we are only using 365 data points, but the Bayesian approach might become problematic for larger data files.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="bayesianmv.html#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting the model</span></span>
<span id="cb26-2"><a href="bayesianmv.html#cb26-2" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb26-3"><a href="bayesianmv.html#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> changepoint,  <span class="co"># Stan program</span></span>
<span id="cb26-4"><a href="bayesianmv.html#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> model_data,        <span class="co"># named list of data</span></span>
<span id="cb26-5"><a href="bayesianmv.html#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,               <span class="co"># number of Markov chains</span></span>
<span id="cb26-6"><a href="bayesianmv.html#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">1000</span>,            <span class="co"># number of warmup iterations per chain</span></span>
<span id="cb26-7"><a href="bayesianmv.html#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">4000</span>,              <span class="co"># total number of iterations per chain</span></span>
<span id="cb26-8"><a href="bayesianmv.html#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">2</span>,                <span class="co"># number of cores (could use one per chain)</span></span>
<span id="cb26-9"><a href="bayesianmv.html#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span>,              <span class="co"># progress not shown</span></span>
<span id="cb26-10"><a href="bayesianmv.html#cb26-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#tail-ess</code></pre>
<p>Fitting may result in a number of warnings, telling us that some problems may have occurred: divergent transitions, large R-hat values, low Effective Sample Size… Obtaining a fit without these warnings takes some practice but is essential for an unbiased interpretation of the inferred variables and predictions. A guide to Stan’s warnings and how to address them <a href="https://mc-stan.org/misc/warnings.html">is available here</a>.</p>
<p>The first step into solving these warnings is to re-run the algorithm with different controls: <code>iter</code>, <code>max_treedepth</code>, etc. If problems persist, it is possible that the model is too complex for the information that the data is able to provide and should be simplified, or that stronger priors should be proposed. A lot of problems can be solved with some prior information. In our specific case, this is especially useful for the variables in the equation for the week-ends, since there are not a lot of data points.</p>
</div>
<div id="validation-and-results" class="section level3 hasAnchor" number="5.3.6">
<h3><span class="header-section-number">5.3.6</span> Validation and results<a href="bayesianmv.html#validation-and-results" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Stan returns an object (called <code>fit1</code> above) <a href="https://cran.r-project.org/web/packages/rstan/vignettes/stanfit-objects.html">from which the distributions of outputs and parameters of the fitted model can be accessed</a></p>
<p>The MCMC algorithm produces a chain of samples <span class="math inline">\(\theta^{(m)}\)</span> for the parameters, which approximate their posterior distributions. In this case, each parameter of the model is represented by a chain of 6,000 draws: from these draws, we can extract any statistics we need: mean, median, quantiles, <span class="math inline">\(t\)</span>-score and <span class="math inline">\(p\)</span>-values, etc.</p>
<div id="parameters" class="section level4 hasAnchor" number="5.3.6.1">
<h4><span class="header-section-number">5.3.6.1</span> Parameters<a href="bayesianmv.html#parameters" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>As a first validation step, it is useful to take a look at the values of the parameters that have been estimated by the algorithm. Below, we use three diagnostics tools:</p>
<ul>
<li>The <code>print</code> method shows the table of parameters, much like we could display after an ordinary linear regression</li>
<li><code>traceplot</code> shows the traces of the selected parameters. If the fitting has converged, the traces approximate the posterior distributions</li>
<li><code>pairs</code> shows the pairwise relationships between parameters. Strong interactions between some parameters are an indication that the model should be re-parameterised.</li>
</ul>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="bayesianmv.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit1, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta_h&quot;</span>, <span class="st">&quot;tau_h&quot;</span>, <span class="st">&quot;beta_c&quot;</span>, <span class="st">&quot;tau_c&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;savings&quot;</span>))</span></code></pre></div>
<pre><code>## Inference for Stan model: 00b679580a50f560b8d7e4a217a14cb6.
## 2 chains, each with iter=4000; warmup=1000; thin=1; 
## post-warmup draws per chain=3000, total post-warmup draws=6000.
## 
##               mean se_mean      sd     2.5%      25%      50%      75%    97.5%
## alpha[1]    448.31    0.96   37.21   355.54   429.62   452.24   473.38   507.88
## alpha[2]    825.45    4.21   33.75   795.41   820.88   829.88   838.26   853.06
## beta_h[1]    35.84    0.05    3.56    29.31    33.44    35.72    38.20    43.00
## beta_h[2]    33.36    0.05    2.87    27.88    31.38    33.34    35.30    38.96
## tau_h[1]      9.88    0.04    1.49     7.37     8.76     9.83    10.77    13.21
## tau_h[2]      6.66    0.14    1.28     5.18     5.96     6.47     7.05     8.92
## beta_c[1]    14.58    0.34    8.36     6.11    10.35    12.76    15.70    43.63
## beta_c[2]    29.20    0.06    3.29    23.16    26.85    29.04    31.45    35.81
## tau_c[1]     16.02    0.15    4.31     7.87    13.59    15.80    17.90    27.13
## tau_c[2]     15.59    0.18    1.63    12.95    15.05    15.81    16.51    17.50
## sigma       103.01    0.06    3.94    95.68   100.28   102.89   105.55   111.16
## savings   69146.29   36.25 2830.25 63683.73 67168.09 69206.84 71091.00 74665.46
##           n_eff Rhat
## alpha[1]   1496 1.00
## alpha[2]     64 1.03
## beta_h[1]  4383 1.00
## beta_h[2]  3701 1.00
## tau_h[1]   1693 1.00
## tau_h[2]     88 1.02
## beta_c[1]   600 1.01
## beta_c[2]  3351 1.00
## tau_c[1]    835 1.00
## tau_c[2]     83 1.02
## sigma      4709 1.00
## savings    6096 1.00
## 
## Samples were drawn using NUTS(diag_e) at Wed Jul 06 14:29:01 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="bayesianmv.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(fit1, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta_h&quot;</span>, <span class="st">&quot;tau_h&quot;</span>, <span class="st">&quot;beta_c&quot;</span>, <span class="st">&quot;tau_c&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;lp__&quot;</span>))</span></code></pre></div>
<p><img src="buildingenergygeeks_files/figure-html/mv07-1.png" width="672" /></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="bayesianmv.html#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fit1, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta_h&quot;</span>, <span class="st">&quot;savings&quot;</span>))</span></code></pre></div>
<p><img src="buildingenergygeeks_files/figure-html/mv07-2.png" width="672" /></p>
</div>
<div id="predictions" class="section level4 hasAnchor" number="5.3.6.2">
<h4><span class="header-section-number">5.3.6.2</span> Predictions<a href="bayesianmv.html#predictions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Our main goal here is to compare the energy use measured during the reporting period <span class="math inline">\(y_\mathit{repo}\)</span> with the predictions of the fitted model. Since it is a probabilistic model, its outcome is actually a probability distribution <span class="math inline">\(p\left(y_\mathit{repo}|x_\mathit{repo}, x_\mathit{base}, y_\mathit{base}\right)\)</span>, based on the observed values of the model inputs <span class="math inline">\(x\)</span> during the baseline and reporting periods, and on the observed energy use during the baseline period <span class="math inline">\(y_\mathit{base}\)</span>.</p>
<p>This so-called <strong>posterior predictive distribution <span class="math inline">\(p\left(y_\mathit{repo}|...\right)\)</span></strong> is already directly available, because a value of <span class="math inline">\(y_\mathit{repo}\)</span> (for each time step) was directly calculated by the Stan model for each value <span class="math inline">\(\theta^{(m)}\)</span> (see <a href="https://mc-stan.org/docs/2_26/stan-users-guide/posterior-prediction-chapter.html">Stan user’s guide</a> for more details).</p>
<p><span class="math display">\[\begin{equation}
p\left(y_\mathit{repo}|...\right) \approx \frac{1}{M} \sum_{m=1}^M p\left(y_\mathit{repo}|x_\mathit{repo},\theta^{(m)}\right)
\end{equation}\]</span></p>
<p>First, let us look at the posterior predictive distribution during the baseline period, in order to validate the model compared to its training data:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="bayesianmv.html#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extracting full predictive distributions from the stanfit object</span></span>
<span id="cb32-2"><a href="bayesianmv.html#cb32-2" aria-hidden="true" tabindex="-1"></a>la <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">extract</span>(fit1, <span class="at">permuted =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-3"><a href="bayesianmv.html#cb32-3" aria-hidden="true" tabindex="-1"></a>y_base_pred <span class="ot">&lt;-</span> la<span class="sc">$</span>y_base_pred</span>
<span id="cb32-4"><a href="bayesianmv.html#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="bayesianmv.html#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Quantiles</span></span>
<span id="cb32-6"><a href="bayesianmv.html#cb32-6" aria-hidden="true" tabindex="-1"></a>y_base_quan <span class="ot">&lt;-</span> <span class="fu">apply</span>(y_base_pred, <span class="dv">2</span>, quantile, <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</span>
<span id="cb32-7"><a href="bayesianmv.html#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="bayesianmv.html#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data frame</span></span>
<span id="cb32-9"><a href="bayesianmv.html#cb32-9" aria-hidden="true" tabindex="-1"></a>df.base.post <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Date =</span> df.base.daily<span class="sc">$</span>Date,</span>
<span id="cb32-10"><a href="bayesianmv.html#cb32-10" aria-hidden="true" tabindex="-1"></a>                           <span class="at">T =</span> df.base.daily<span class="sc">$</span>T,</span>
<span id="cb32-11"><a href="bayesianmv.html#cb32-11" aria-hidden="true" tabindex="-1"></a>                           <span class="at">y =</span> df.base.daily<span class="sc">$</span>E,</span>
<span id="cb32-12"><a href="bayesianmv.html#cb32-12" aria-hidden="true" tabindex="-1"></a>                           <span class="at">w =</span> df.base.daily<span class="sc">$</span>week.end,</span>
<span id="cb32-13"><a href="bayesianmv.html#cb32-13" aria-hidden="true" tabindex="-1"></a>                           <span class="at">pred_low =</span> y_base_quan[<span class="dv">1</span>, ],</span>
<span id="cb32-14"><a href="bayesianmv.html#cb32-14" aria-hidden="true" tabindex="-1"></a>                           <span class="at">pred_med =</span> y_base_quan[<span class="dv">2</span>, ],</span>
<span id="cb32-15"><a href="bayesianmv.html#cb32-15" aria-hidden="true" tabindex="-1"></a>                           <span class="at">pred_up =</span> y_base_quan[<span class="dv">3</span>, ])</span>
<span id="cb32-16"><a href="bayesianmv.html#cb32-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-17"><a href="bayesianmv.html#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb32-18"><a href="bayesianmv.html#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> df.base.post) <span class="sc">+</span></span>
<span id="cb32-19"><a href="bayesianmv.html#cb32-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>T, <span class="at">y=</span>y, <span class="at">color=</span>w)) <span class="sc">+</span></span>
<span id="cb32-20"><a href="bayesianmv.html#cb32-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> . <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>df.base.post<span class="sc">$</span>w), <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>T, <span class="at">y=</span>pred_med), <span class="at">color=</span><span class="st">&#39;red&#39;</span>) <span class="sc">+</span></span>
<span id="cb32-21"><a href="bayesianmv.html#cb32-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> . <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>df.base.post<span class="sc">$</span>w), <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>T, <span class="at">ymin=</span>pred_low, <span class="at">ymax=</span>pred_up), <span class="at">fill=</span><span class="st">&#39;red&#39;</span>, <span class="at">alpha=</span><span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb32-22"><a href="bayesianmv.html#cb32-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> . <span class="sc">%&gt;%</span> <span class="fu">filter</span>(df.base.post<span class="sc">$</span>w), <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>T, <span class="at">y=</span>pred_med), <span class="at">color=</span><span class="st">&#39;blue&#39;</span>) <span class="sc">+</span></span>
<span id="cb32-23"><a href="bayesianmv.html#cb32-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> . <span class="sc">%&gt;%</span> <span class="fu">filter</span>(df.base.post<span class="sc">$</span>w), <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>T, <span class="at">ymin=</span>pred_low, <span class="at">ymax=</span>pred_up), <span class="at">fill=</span><span class="st">&#39;blue&#39;</span>, <span class="at">alpha=</span><span class="fl">0.1</span>)</span></code></pre></div>
<p><img src="buildingenergygeeks_files/figure-html/mv08-1.png" width="672" /></p>
<p>The colored bands show a 95% prediction interval for the working days and the week ends, respectively. The points are the measurements of the baseline period.</p>
</div>
</div>
<div id="residuals" class="section level3 hasAnchor" number="5.3.7">
<h3><span class="header-section-number">5.3.7</span> Residuals<a href="bayesianmv.html#residuals" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>An important validation step is to check for autocorrelation in the residuals of the fitted model, on the baseline data that was used for fitting. Autocorrelation is often a sign of insufficient model complexity, or that the form of the model error term has not been appropriately chosen.</p>
<p>The two graphs below show:</p>
<ul>
<li>Residuals vs Date, in order to display eventual autocorrelation</li>
<li>residuals vs Temperature</li>
</ul>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="bayesianmv.html#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> df.base.post) <span class="sc">+</span></span>
<span id="cb33-2"><a href="bayesianmv.html#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>Date, <span class="at">y=</span>pred_med<span class="sc">-</span>y)) <span class="sc">+</span></span>
<span id="cb33-3"><a href="bayesianmv.html#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>Date, <span class="at">ymin=</span>pred_low<span class="sc">-</span>y, <span class="at">ymax=</span>pred_up<span class="sc">-</span>y), <span class="at">alpha=</span><span class="fl">0.2</span>)</span></code></pre></div>
<p><img src="buildingenergygeeks_files/figure-html/mv09-1.png" width="672" /></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="bayesianmv.html#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> df.base.post) <span class="sc">+</span></span>
<span id="cb34-2"><a href="bayesianmv.html#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>T, <span class="at">y=</span>pred_med<span class="sc">-</span>y)) <span class="sc">+</span></span>
<span id="cb34-3"><a href="bayesianmv.html#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>T, <span class="at">ymin=</span>pred_low<span class="sc">-</span>y, <span class="at">ymax=</span>pred_up<span class="sc">-</span>y), <span class="at">alpha=</span><span class="fl">0.2</span>)</span></code></pre></div>
<p><img src="buildingenergygeeks_files/figure-html/mv10-1.png" width="672" /></p>
<p>The second graph is fine, but it seems that these is a trend in the residuals in the first few months and last few months of the year, suggesting that the model doesn’t quite capture the winter energy consumption very well.</p>
</div>
<div id="savings" class="section level3 hasAnchor" number="5.3.8">
<h3><span class="header-section-number">5.3.8</span> Savings<a href="bayesianmv.html#savings" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Our Stan model already calculates the expected output <span class="math inline">\(y\)</span> of the reporting period, for each sample <span class="math inline">\(\theta_i\)</span> of the posterior distribution. We can therefore display a probability distribution for each of the data points of the reporting period, and compare it with the measured data in the same period.</p>
<p>The following graph compares the energy use measured during the <strong>reporting period</strong> (points) with the probability distributions of energy use predicted by the model during the same period.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="bayesianmv.html#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extracting full predictive distributions from the stanfit object</span></span>
<span id="cb35-2"><a href="bayesianmv.html#cb35-2" aria-hidden="true" tabindex="-1"></a>y_repo_pred <span class="ot">&lt;-</span> la<span class="sc">$</span>y_repo_pred</span>
<span id="cb35-3"><a href="bayesianmv.html#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Quantiles</span></span>
<span id="cb35-4"><a href="bayesianmv.html#cb35-4" aria-hidden="true" tabindex="-1"></a>y_repo_quan <span class="ot">&lt;-</span> <span class="fu">apply</span>(y_repo_pred, <span class="dv">2</span>, quantile, <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</span>
<span id="cb35-5"><a href="bayesianmv.html#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data frame</span></span>
<span id="cb35-6"><a href="bayesianmv.html#cb35-6" aria-hidden="true" tabindex="-1"></a>df.repo.post <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Date =</span> df.repo.daily<span class="sc">$</span>Date, <span class="at">T =</span> df.repo.daily<span class="sc">$</span>T, <span class="at">y =</span> df.repo.daily<span class="sc">$</span>E, <span class="at">w =</span> df.repo.daily<span class="sc">$</span>week.end,</span>
<span id="cb35-7"><a href="bayesianmv.html#cb35-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">pred_low =</span> y_repo_quan[<span class="dv">1</span>, ], <span class="at">pred_med =</span> y_repo_quan[<span class="dv">2</span>, ], <span class="at">pred_up =</span> y_repo_quan[<span class="dv">3</span>, ])</span>
<span id="cb35-8"><a href="bayesianmv.html#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb35-9"><a href="bayesianmv.html#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> df.repo.post) <span class="sc">+</span></span>
<span id="cb35-10"><a href="bayesianmv.html#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>T, <span class="at">y=</span>y, <span class="at">color=</span>w)) <span class="sc">+</span></span>
<span id="cb35-11"><a href="bayesianmv.html#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> . <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>df.repo.post<span class="sc">$</span>w), <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>T, <span class="at">y=</span>pred_med), <span class="at">color=</span><span class="st">&#39;red&#39;</span>) <span class="sc">+</span></span>
<span id="cb35-12"><a href="bayesianmv.html#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> . <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>df.repo.post<span class="sc">$</span>w), <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>T, <span class="at">ymin=</span>pred_low, <span class="at">ymax=</span>pred_up), <span class="at">fill=</span><span class="st">&#39;red&#39;</span>, <span class="at">alpha=</span><span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb35-13"><a href="bayesianmv.html#cb35-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> . <span class="sc">%&gt;%</span> <span class="fu">filter</span>(df.repo.post<span class="sc">$</span>w), <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>T, <span class="at">y=</span>pred_med), <span class="at">color=</span><span class="st">&#39;blue&#39;</span>) <span class="sc">+</span></span>
<span id="cb35-14"><a href="bayesianmv.html#cb35-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> . <span class="sc">%&gt;%</span> <span class="fu">filter</span>(df.repo.post<span class="sc">$</span>w), <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>T, <span class="at">ymin=</span>pred_low, <span class="at">ymax=</span>pred_up), <span class="at">fill=</span><span class="st">&#39;blue&#39;</span>, <span class="at">alpha=</span><span class="fl">0.1</span>)</span></code></pre></div>
<p><img src="buildingenergygeeks_files/figure-html/mv11-1.png" width="672" /></p>
<p>The savings, i.e. the difference between the measured energy use during the reporting period and their prediction by the model, have been included in the Stan model definition. Similarly to the prediction, <strong>the savings are therefore available as a probability distribution</strong>: we have a full description of any confidence interval we may wish for.</p>
<p>The table of results shown after model fitting shows that</p>
<ul>
<li>The mean estimated savings are 69,069 kWh</li>
<li>The 95% confidence interval spans between 63,550 and 74,880 kWh</li>
</ul>
<p>We can also choose to display any quantile of the posterior distribution of savings:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="bayesianmv.html#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit1, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;savings&quot;</span>))</span></code></pre></div>
<pre><code>## ci_level: 0.8 (80% intervals)</code></pre>
<pre><code>## outer_level: 0.95 (95% intervals)</code></pre>
<p><img src="buildingenergygeeks_files/figure-html/mv12-1.png" width="672" /></p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="ordinary-linear-regression.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="finite-mixture-models.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
